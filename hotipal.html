<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hospital Bed Status Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#f5f7fa;
      --panel:#ffffff;
      --border:#d1d5db;
      --text:#1f2937;
      --ok:#22c55e;
      --warn:#eab308;
      --crit:#dc2626;
    }
    body{background:#f5f7fa;color:#1f2937;font-family:Arial,sans-serif}
    .bed-card{
      transition:all .2s ease;
      cursor:pointer;
      background:#fff;
      box-shadow:0 1px 3px rgba(0,0,0,0.08);
      position:relative;
    }
    .bed-card:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
    }
    .bed-card.calling::after{
      content:'';
      position:absolute;
      inset:0;
      border:3px solid #ef4444;
      border-radius:12px;
      animation:callBlink 1s infinite;
    }
    @keyframes callBlink{
      0%,100%{opacity:1}
      50%{opacity:0.3}
    }
    .status-dot{width:.75rem;height:.75rem;border-radius:50%;display:inline-block;margin-right:.25rem}
    table{width:100%;border-collapse:collapse}
    th{background:#f9fafb;font-weight:600;text-align:left;padding:.75rem;border-bottom:2px solid #e5e7eb}
    td{padding:.75rem;border-bottom:1px solid #e5e7eb}
    .mic-pulse{animation:pulse 2s infinite}
    @keyframes pulse{
      0%,100%{transform:scale(1);box-shadow:0 0 0 0 rgba(239,68,68,0.7)}
      50%{transform:scale(1.05);box-shadow:0 0 0 20px rgba(239,68,68,0)}
    }
    .wave-bar{
      width:4px;
      background:linear-gradient(to top,#3b82f6,#06b6d4);
      border-radius:2px;
      animation:wave 1s ease-in-out infinite;
    }
    .wave-bar:nth-child(1){animation-delay:0s;height:20%}
    .wave-bar:nth-child(2){animation-delay:0.1s;height:40%}
    .wave-bar:nth-child(3){animation-delay:0.2s;height:60%}
    .wave-bar:nth-child(4){animation-delay:0.3s;height:80%}
    .wave-bar:nth-child(5){animation-delay:0.4s;height:100%}
    .wave-bar:nth-child(6){animation-delay:0.5s;height:80%}
    .wave-bar:nth-child(7){animation-delay:0.6s;height:60%}
    .wave-bar:nth-child(8){animation-delay:0.7s;height:40%}
    @keyframes wave{
      0%,100%{height:20%}
      50%{height:100%}
    }
    .alert-notification{
      position:fixed;
      top:20px;
      right:20px;
      z-index:1000;
      animation:slideIn 0.3s ease-out;
    }
    @keyframes slideIn{
      from{transform:translateX(400px);opacity:0}
      to{transform:translateX(0);opacity:1}
    }
  </style>
</head>
<body class="min-h-screen font-sans">
  <div class="max-w-7xl mx-auto p-4" style="background:#fff;min-height:100vh;box-shadow:0 0 30px rgba(0,0,0,0.08)">
    <header class="border-b-4 border-gradient pb-4 mb-6" style="border-image:linear-gradient(90deg,#3b82f6,#06b6d4) 1">
      <div class="flex items-center gap-3 mb-3">
        <div class="w-14 h-14 bg-gradient-to-br from-blue-600 to-cyan-500 rounded-xl flex items-center justify-center text-white font-bold text-2xl shadow-lg">H+</div>
        <div>
          <h1 class="text-3xl font-extrabold bg-gradient-to-r from-blue-600 to-cyan-500 bg-clip-text text-transparent">Hospital Bed Status Dashboard</h1>
          <p class="text-sm text-gray-600">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</p>
        </div>
      </div>
      <div class="flex gap-2 items-center mt-4 flex-wrap">
        <span class="text-sm text-gray-700 font-semibold">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£:</span>
        <select id="buildingSelect" class="px-4 py-2 border-2 border-gray-200 rounded-lg bg-white text-sm hover:border-blue-400 transition-colors">
          <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        </select>
        <input id="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏ï‡∏µ‡∏¢‡∏á/‡∏ä‡∏∑‡πà‡∏≠" class="px-4 py-2 border-2 border-gray-200 rounded-lg text-sm flex-1 min-w-[200px] hover:border-blue-400 focus:border-blue-500 focus:outline-none transition-colors" />
        <button id="refreshBtn" class="px-5 py-2 bg-gradient-to-r from-blue-600 to-cyan-500 text-white rounded-lg font-semibold text-sm hover:shadow-lg transition-all">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        <button id="historyBtn" class="px-5 py-2 bg-gradient-to-r from-purple-600 to-pink-500 text-white rounded-lg font-semibold text-sm hover:shadow-lg transition-all">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
        <span class="text-xs text-gray-500 ml-auto">‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="lastUpdate" class="font-semibold">-</span></span>
      </div>
    </header>

    <section class="grid grid-cols-1 lg:grid-cols-4 gap-5">
      <aside class="col-span-1 lg:col-span-1">
        <div class="bg-gradient-to-br from-blue-50 to-cyan-50 border-2 border-blue-200 rounded-xl p-5 mb-4 shadow-sm">
          <h2 class="font-bold text-gray-900 text-lg mb-4 pb-2 border-b-2 border-blue-300">‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h2>
          <table class="w-full text-sm">
            <tr><td class="py-2.5 text-gray-700 font-medium">‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td><td class="py-2.5 text-right font-bold text-gray-900 text-lg"><span id="totalBeds">0</span> ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á</td></tr>
            <tr><td class="py-2.5 text-gray-700 font-medium"><span class="status-dot" style="background:var(--ok)"></span>‡∏ß‡πà‡∏≤‡∏á</td><td class="py-2.5 text-right font-bold text-green-600 text-lg" id="totalAvailable">0</td></tr>
            <tr><td class="py-2.5 text-gray-700 font-medium"><span class="status-dot" style="background:var(--warn)"></span>‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</td><td class="py-2.5 text-right font-bold text-yellow-600 text-lg" id="totalOccupied">0</td></tr>
            <tr><td class="py-2.5 text-gray-700 font-medium"><span class="status-dot" style="background:var(--crit)"></span>‡∏ß‡∏¥‡∏Å‡∏§‡∏ï</td><td class="py-2.5 text-right font-bold text-red-600 text-lg" id="totalCritical">0</td></tr>
          </table>
        </div>

        <div class="bg-white border-2 border-gray-200 rounded-xl p-4 shadow-sm mb-4">
          <h3 class="font-bold text-gray-900 text-sm mb-2">‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ 24 ‡∏ä‡∏°.</h3>
          <canvas id="statsChart" height="150"></canvas>
        </div>

        <div class="bg-white border-2 border-gray-200 rounded-xl p-5 shadow-sm">
          <h3 class="font-bold text-gray-900 text-sm mb-3">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h3>
          <div class="space-y-3 text-xs text-gray-700">
            <div class="flex items-start gap-2 p-2 bg-green-50 rounded-lg"><span class="status-dot mt-0.5" style="background:var(--ok)"></span><div><strong>‡∏ß‡πà‡∏≤‡∏á:</strong> ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</div></div>
            <div class="flex items-start gap-2 p-2 bg-yellow-50 rounded-lg"><span class="status-dot mt-0.5" style="background:var(--warn)"></span><div><strong>‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</strong> ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ä‡∏µ‡∏û‡∏õ‡∏Å‡∏ï‡∏¥</div></div>
            <div class="flex items-start gap-2 p-2 bg-red-50 rounded-lg"><span class="status-dot mt-0.5" style="background:var(--crit)"></span><div><strong>‡∏ß‡∏¥‡∏Å‡∏§‡∏ï:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©</div></div>
          </div>
        </div>
      </aside>

      <main class="col-span-1 lg:col-span-3">
        <div id="buildingsContainer" class="space-y-5"></div>
      </main>
    </section>
  </div>

  <!-- Alert Notification -->
  <div id="alertContainer"></div>

  <!-- Patient Details Modal -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-4xl w-full mx-4 border-2 border-gray-200 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-start border-b-2 border-gray-200 pb-4 mb-5">
        <div>
          <h3 id="modalTitle" class="text-2xl font-bold text-gray-900"></h3>
          <p id="modalSub" class="text-sm text-gray-600 mt-1"></p>
        </div>
        <button id="closeModal" class="text-gray-400 hover:text-gray-700 font-bold text-3xl px-2 leading-none">√ó</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
        <div class="space-y-4">
          <div class="bg-gradient-to-br from-blue-50 to-cyan-50 border-2 border-blue-200 rounded-xl p-5">
            <h4 class="font-bold text-gray-900 mb-4 text-sm">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h4>
            <table class="w-full text-sm">
              <tr><td class="py-2 text-gray-700 font-medium">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</td><td class="py-2 font-bold" id="modalPatientName"></td></tr>
              <tr><td class="py-2 text-gray-700 font-medium">‡∏≠‡∏≤‡∏¢‡∏∏/‡πÄ‡∏û‡∏®:</td><td class="py-2 font-semibold" id="modalPatientAge"></td></tr>
              <tr><td class="py-2 text-gray-700 font-medium">‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏Å‡∏©‡∏≤:</td><td class="py-2 font-semibold text-purple-700" id="modalDisease"></td></tr>
              <tr><td class="py-2 text-gray-700 font-medium">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤:</td><td class="py-2 font-semibold" id="modalAdmitDate"></td></tr>
              <tr><td class="py-2 text-gray-700 font-medium">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</td><td class="py-2 font-bold"><span id="modalStatus"></span></td></tr>
            </table>
          </div>

          <div class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl p-5">
            <h4 class="font-bold text-gray-900 mb-4 text-sm">Vital Signs</h4>
            <div class="grid grid-cols-2 gap-3 text-sm">
              <div class="bg-white p-3 rounded-lg border border-green-100">
                <div class="text-xs text-gray-600">Heart Rate</div>
                <div class="text-lg font-bold text-blue-700" id="modalHR"></div>
              </div>
              <div class="bg-white p-3 rounded-lg border border-green-100">
                <div class="text-xs text-gray-600">Temperature</div>
                <div class="text-lg font-bold text-orange-600" id="modalTemp"></div>
              </div>
              <div class="bg-white p-3 rounded-lg border border-green-100">
                <div class="text-xs text-gray-600">Blood Pressure</div>
                <div class="text-lg font-bold text-red-600" id="modalBP"></div>
              </div>
              <div class="bg-white p-3 rounded-lg border border-green-100">
                <div class="text-xs text-gray-600">SpO2</div>
                <div class="text-lg font-bold text-cyan-600" id="modalSpO2"></div>
              </div>
            </div>
          </div>

          <div class="bg-white border-2 border-gray-200 rounded-xl p-5">
            <h4 class="font-bold text-gray-900 mb-3 text-sm">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</h4>
            <div id="medicationList" class="space-y-2 text-xs"></div>
          </div>
        </div>

        <div class="space-y-4">
          <div class="bg-gradient-to-br from-gray-50 to-slate-50 border-2 border-gray-200 rounded-xl p-5">
            <h4 class="font-bold text-gray-900 mb-3 text-sm">‡∏Å‡∏£‡∏≤‡∏ü ECG</h4>
            <div class="bg-white border-2 border-gray-300 rounded-lg p-3">
              <svg viewBox="0 0 200 40" class="w-full h-20" preserveAspectRatio="none">
                <path id="ecgPath" d="M0 20 L25 20 L30 10 L40 30 L60 20 L200 20" stroke="#3b82f6" stroke-width="2.5" fill="none" stroke-dasharray="1000" stroke-dashoffset="1000" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <p class="text-xs text-gray-500 mt-2 text-center font-medium">Real-time monitoring</p>
            </div>
          </div>

          <div class="bg-white border-2 border-gray-200 rounded-xl p-5">
            <h4 class="font-bold text-gray-900 mb-3 text-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏û‡∏ó‡∏¢‡πå</h4>
            <div id="doctorNotes" class="text-sm text-gray-700 bg-gray-50 p-3 rounded-lg max-h-32 overflow-y-auto"></div>
          </div>

          <div class="bg-white border-2 border-gray-200 rounded-xl p-5">
            <h4 class="font-bold text-gray-900 mb-3 text-sm">‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå</h4>
            <div id="appointments" class="space-y-2 text-xs"></div>
          </div>

          <button id="chatBtn" class="w-full px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg font-semibold text-sm hover:shadow-lg transition-all flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z"/>
            </svg>
            ‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (Voice)
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Voice Call Modal -->
  <div id="chatModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 border-2 border-gray-200">
      <div class="flex justify-between items-center border-b-2 border-gray-200 p-5">
        <div>
          <h3 class="text-xl font-bold text-gray-900">Voice Call</h3>
          <p id="chatBedInfo" class="text-sm text-gray-600"></p>
        </div>
        <button id="closeChatModal" class="text-gray-400 hover:text-gray-700 font-bold text-3xl px-2 leading-none">√ó</button>
      </div>
      <div class="p-8 flex flex-col items-center">
        <div id="voiceAvatar" class="w-32 h-32 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center mb-6 shadow-lg">
          <svg class="w-16 h-16 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
          </svg>
        </div>
        <div id="callStatus" class="text-lg font-semibold text-gray-700 mb-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</div>
        <div id="callTimer" class="text-sm text-gray-500 mb-6">00:00</div>
        
        <div id="micButton" class="w-20 h-20 rounded-full bg-gradient-to-br from-red-500 to-pink-600 flex items-center justify-center cursor-pointer hover:shadow-2xl transition-all mb-4 mic-pulse">
          <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z"/>
          </svg>
        </div>
        <div class="text-xs text-gray-500 mb-6">‡∏Å‡∏î‡πÑ‡∏°‡∏Ñ‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î</div>
        
        <div id="voiceWaveform" class="hidden w-full h-16 bg-gray-100 rounded-lg mb-4 flex items-center justify-center gap-1 px-4">
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
        </div>
        
        <div id="transcriptBox" class="w-full bg-gray-50 border-2 border-gray-200 rounded-lg p-4 text-sm text-gray-700 min-h-[100px] max-h-[300px] overflow-y-auto">
          <div class="text-gray-400 text-center">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- History Modal -->
  <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-4xl w-full mx-4 border-2 border-gray-200 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-start border-b-2 border-gray-200 pb-4 mb-5">
        <div>
          <h3 class="text-2xl font-bold text-gray-900">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ï‡∏µ‡∏¢‡∏á</h3>
          <p class="text-sm text-gray-600 mt-1">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
        </div>
        <button id="closeHistoryModal" class="text-gray-400 hover:text-gray-700 font-bold text-3xl px-2 leading-none">√ó</button>
      </div>
      <div id="historyList" class="space-y-2 max-h-[60vh] overflow-y-auto"></div>
    </div>
  </div>

  <script>
    const BUILDINGS = 4;
    const BEDS_PER_BUILDING = 50;
    const STATUS = { AVAILABLE: 'available', OCCUPIED: 'occupied', CRITICAL: 'critical' };
    
    const THAI_NAMES = ["‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ", "‡∏™‡∏∏‡∏î‡∏≤ ‡∏£‡∏±‡∏Å‡∏©‡∏≤", "‡∏ß‡∏¥‡∏ä‡∏±‡∏¢ ‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á", "‡∏≠‡∏£‡∏ó‡∏±‡∏¢ ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°", "‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏ó‡∏ò‡πå ‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏Ç‡πá‡∏á", "‡∏°‡∏≤‡∏•‡∏µ ‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ", "‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏Å‡∏•‡πâ‡∏≤‡∏´‡∏≤‡∏ç", "‡∏ß‡∏≤‡∏£‡∏∏‡∏ì‡∏µ ‡∏≠‡∏£‡∏∏‡∏ì‡∏™‡∏ß‡πà‡∏≤‡∏á", "‡∏ô‡∏¥‡∏£‡∏±‡∏ô‡∏î‡∏£‡πå ‡∏¢‡∏∑‡∏ô‡∏¢‡∏≤‡∏ß", "‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å"];
    const DISEASES = ["‡πÑ‡∏Ç‡πâ‡∏´‡∏ß‡∏±‡∏î", "‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏´‡∏±‡∏Å", "COVID-19", "‡∏õ‡∏≠‡∏î‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö", "‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á", "‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à", "‡πÑ‡∏ï‡∏ß‡∏≤‡∏¢", "‡∏°‡∏∞‡πÄ‡∏£‡πá‡∏á", "‡πÑ‡∏Ç‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å"];
    const MEDICATIONS = [
      {name: "Paracetamol", time: "08:00, 20:00", purpose: "‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î ‡∏•‡∏î‡πÑ‡∏Ç‡πâ"},
      {name: "Amoxicillin", time: "08:00, 14:00, 20:00", purpose: "‡∏¢‡∏≤‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞"},
      {name: "Metformin", time: "07:00, 19:00", purpose: "‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•"},
      {name: "Atenolol", time: "08:00", purpose: "‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô"},
      {name: "Omeprazole", time: "07:00", purpose: "‡∏•‡∏î‡∏Å‡∏£‡∏î‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏û‡∏≤‡∏∞"}
    ];
    const DOCTOR_NOTES_EXAMPLES = [
      "‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô ‡πÅ‡∏ú‡∏•‡∏´‡∏≤‡∏¢‡∏î‡∏µ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°",
      "‡∏¢‡∏±‡∏á‡∏°‡∏µ‡πÑ‡∏Ç‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á",
      "‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ä‡∏µ‡∏û‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏á‡∏ó‡∏µ‡πà ‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÑ‡∏õ",
      "‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ß‡∏£‡∏û‡∏±‡∏Å‡∏≠‡∏µ‡∏Å 2-3 ‡∏ß‡∏±‡∏ô",
      "‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏ß‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡πÑ‡∏î‡πâ‡∏ó‡∏≥ EKG ‡πÅ‡∏•‡πâ‡∏ß ‡∏õ‡∏Å‡∏ï‡∏¥"
    ];

    let hospital = [];
    let statusHistory = [];
    let chartInstance = null;
    let currentBed = null;
    let isListening = false;
    let callStartTime = null;
    let timerInterval = null;

    function generateMockData(){
      const buildings = [];
      for(let b=1;b<=BUILDINGS;b++){
        const beds = [];
        for(let i=1;i<=BEDS_PER_BUILDING;i++){
          const id = `B${b}-${String(i).padStart(2,'0')}`;
          const r = Math.random();
          let status = STATUS.AVAILABLE;
          if(r>0.6) status = STATUS.OCCUPIED;
          if(r>0.95) status = STATUS.CRITICAL;
          
          const patientName = status === STATUS.AVAILABLE ? null : THAI_NAMES[Math.floor(Math.random()*THAI_NAMES.length)];
          const age = status === STATUS.AVAILABLE ? null : Math.floor(Math.random()*60)+20;
          const gender = status === STATUS.AVAILABLE ? null : (Math.random()>0.5 ? '‡∏ä‡∏≤‡∏¢' : '‡∏´‡∏ç‡∏¥‡∏á');
          const disease = status === STATUS.AVAILABLE ? null : DISEASES[Math.floor(Math.random()*DISEASES.length)];
          const daysAdmitted = status === STATUS.AVAILABLE ? null : Math.floor(Math.random()*10)+1;
          const hr = status === STATUS.AVAILABLE ? null : (status === STATUS.CRITICAL ? Math.floor(40 + Math.random()*40) : Math.floor(60 + Math.random()*30));
          const temp = status === STATUS.AVAILABLE ? null : (36.5 + Math.random()*2).toFixed(1);
          const bp = status === STATUS.AVAILABLE ? null : `${Math.floor(100+Math.random()*40)}/${Math.floor(60+Math.random()*20)}`;
          const spo2 = status === STATUS.AVAILABLE ? null : (status === STATUS.CRITICAL ? Math.floor(85+Math.random()*10) : Math.floor(95+Math.random()*5));
          const medications = status === STATUS.AVAILABLE ? [] : MEDICATIONS.slice(0, Math.floor(Math.random()*3)+1);
          const doctorNotes = status === STATUS.AVAILABLE ? null : DOCTOR_NOTES_EXAMPLES[Math.floor(Math.random()*DOCTOR_NOTES_EXAMPLES.length)];
          const isCalling = false;
          
          beds.push({
            id, status, patientName, age, gender, disease, daysAdmitted, hr, temp, bp, spo2, medications, doctorNotes, isCalling,
            lastUpdate: new Date().toLocaleTimeString()
          });
        }
        buildings.push({name:`‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ${b}`, code:`B${b}`, beds});
      }
      return buildings;
    }

    hospital = generateMockData();

    // Initialize chart
    function initChart(){
      const ctx = document.getElementById('statsChart').getContext('2d');
      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['00:00','06:00','12:00','18:00','24:00'],
          datasets: [
            {label:'‡∏ß‡πà‡∏≤‡∏á',data:[120,110,100,95,90],borderColor:'#22c55e',tension:0.4,borderWidth:2},
            {label:'‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',data:[70,80,90,95,100],borderColor:'#eab308',tension:0.4,borderWidth:2},
            {label:'‡∏ß‡∏¥‡∏Å‡∏§‡∏ï',data:[10,10,10,10,10],borderColor:'#dc2626',tension:0.4,borderWidth:2}
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {display: true, position: 'bottom', labels: {boxWidth: 12, padding: 8, font: {size: 10}}}
          },
          scales: {
            y: {beginAtZero: true, max: 150, ticks: {font: {size: 10}}},
            x: {ticks: {font: {size: 10}}}
          }
        }
      });
    }

    initChart();

    const buildingSelect = document.getElementById('buildingSelect');
    for(const b of hospital){
      const opt = document.createElement('option');
      opt.value = b.code;
      opt.textContent = b.name;
      buildingSelect.appendChild(opt);
    }

    function updateOverview(){
      const totalBeds = BUILDINGS * BEDS_PER_BUILDING;
      let avail=0,occ=0,crit=0;
      hospital.forEach(b=>b.beds.forEach(bd=>{
        if(bd.status===STATUS.AVAILABLE) avail++;
        else if(bd.status===STATUS.OCCUPIED) occ++;
        else crit++;
      }));
      document.getElementById('totalBeds').textContent = totalBeds;
      document.getElementById('totalAvailable').textContent = avail;
      document.getElementById('totalOccupied').textContent = occ;
      document.getElementById('totalCritical').textContent = crit;
    }

    function statusBadge(status){
      if(status===STATUS.AVAILABLE) return `<span class="px-3 py-1.5 rounded-lg text-xs font-bold bg-green-100 text-green-700 border-2 border-green-300">‡∏ß‡πà‡∏≤‡∏á</span>`;
      if(status===STATUS.OCCUPIED) return `<span class="px-3 py-1.5 rounded-lg text-xs font-bold bg-yellow-100 text-yellow-700 border-2 border-yellow-300">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>`;
      return `<span class="px-3 py-1.5 rounded-lg text-xs font-bold bg-red-100 text-red-700 border-2 border-red-300">‡∏ß‡∏¥‡∏Å‡∏§‡∏ï</span>`;
    }

    function showAlert(bed, message){
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert-notification bg-red-500 text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-3';
      alertDiv.innerHTML = `
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
        </svg>
        <div>
          <div class="font-bold">${message}</div>
          <div class="text-sm">‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${bed.id} - ${bed.patientName || '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢'}</div>
        </div>
      `;
      document.getElementById('alertContainer').appendChild(alertDiv);
      
      // Play alert sound
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYJGmS65OOXTR0aaLrs7aRXFw5Kqufwy2gwBSJ8z++8dSYFJ4DN8teINQgYZbjn45ZOGxBQquXwvGYfBjKA0PHeizkJGWK66OmgURwOT6rl8cdqKwUjfM3vwXkoHmS76OykVxcNSqrm8Mp');
      audio.play().catch(()=>{});
      
      setTimeout(()=>{
        alertDiv.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(()=>alertDiv.remove(), 300);
      }, 5000);
    }

    function addToHistory(bed, oldStatus, newStatus){
      const entry = {
        time: new Date().toLocaleTimeString(),
        bedId: bed.id,
        patientName: bed.patientName,
        oldStatus,
        newStatus,
        timestamp: Date.now()
      };
      statusHistory.unshift(entry);
      if(statusHistory.length > 100) statusHistory.pop();
    }

    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalSub = document.getElementById('modalSub');
    const modalPatientName = document.getElementById('modalPatientName');
    const modalPatientAge = document.getElementById('modalPatientAge');
    const modalDisease = document.getElementById('modalDisease');
    const modalAdmitDate = document.getElementById('modalAdmitDate');
    const modalStatus = document.getElementById('modalStatus');
    const modalHR = document.getElementById('modalHR');
    const modalTemp = document.getElementById('modalTemp');
    const modalBP = document.getElementById('modalBP');
    const modalSpO2 = document.getElementById('modalSpO2');
    const medicationList = document.getElementById('medicationList');
    const doctorNotes = document.getElementById('doctorNotes');
    const appointments = document.getElementById('appointments');

    function openModal(bed){
      currentBed = bed;
      modalTitle.textContent = `‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${bed.id}`;
      modalSub.textContent = `‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£: ${bed.id.split('-')[0]}`;
      modalPatientName.textContent = bed.patientName || '-';
      modalPatientAge.textContent = bed.age && bed.gender ? `${bed.age} ‡∏õ‡∏µ / ${bed.gender}` : '-';
      modalDisease.textContent = bed.disease || '-';
      modalAdmitDate.textContent = bed.daysAdmitted ? `${bed.daysAdmitted} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß` : '-';
      modalStatus.textContent = bed.status === STATUS.AVAILABLE ? '‡∏ß‡πà‡∏≤‡∏á' : bed.status === STATUS.OCCUPIED ? '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏ß‡∏¥‡∏Å‡∏§‡∏ï';
      modalHR.textContent = bed.hr ? `${bed.hr} bpm` : '-';
      modalTemp.textContent = bed.temp ? `${bed.temp} ¬∞C` : '-';
      modalBP.textContent = bed.bp || '-';
      modalSpO2.textContent = bed.spo2 ? `${bed.spo2}%` : '-';
      
      // Medications
      medicationList.innerHTML = '';
      if(bed.medications && bed.medications.length > 0){
        bed.medications.forEach(med => {
          medicationList.innerHTML += `
            <div class="bg-purple-50 border border-purple-200 rounded p-2">
              <div class="font-bold text-purple-900">${med.name}</div>
              <div class="text-gray-600">‡πÄ‡∏ß‡∏•‡∏≤: ${med.time}</div>
              <div class="text-gray-500">${med.purpose}</div>
            </div>
          `;
        });
      } else {
        medicationList.innerHTML = '<div class="text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
      }
      
      // Doctor notes
      doctorNotes.textContent = bed.doctorNotes || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
      
      // Appointments
      appointments.innerHTML = '';
      if(bed.status !== STATUS.AVAILABLE){
        const appointmentDates = [
          {doctor: '‡∏ô‡∏û.‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', date: '‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ 10:00', dept: '‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°'},
          {doctor: '‡∏û‡∏ç.‡∏™‡∏∏‡∏î‡∏≤ ‡∏£‡∏±‡∏Å‡∏©‡∏≤', date: '‡∏ß‡∏±‡∏ô‡∏û‡∏§‡∏´‡∏±‡∏™ 14:00', dept: '‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£'}
        ];
        appointmentDates.forEach(apt => {
          appointments.innerHTML += `
            <div class="bg-blue-50 border border-blue-200 rounded p-2">
              <div class="font-bold text-blue-900">${apt.doctor}</div>
              <div class="text-gray-600">${apt.date} - ${apt.dept}</div>
            </div>
          `;
        });
      } else {
        appointments.innerHTML = '<div class="text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</div>';
      }
      
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      
      const chatBtn = document.getElementById('chatBtn');
      if(bed.status === STATUS.AVAILABLE){
        chatBtn.style.display = 'none';
      } else {
        chatBtn.style.display = 'flex';
      }
      
      if(bed.hr){
        const speed = Math.max(0.5, 2 - (bed.hr-60)/100);
        ecgPath.style.animation = `draw ${speed}s linear infinite`;
      } else {
        ecgPath.style.animation = 'none';
      }
    }

    document.getElementById('closeModal').onclick = ()=>{
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    };
    
    modal.addEventListener('click', (e)=>{
      if(e.target===modal){
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    });

    // Voice call modal
    const chatModal = document.getElementById('chatModal');
    const chatBedInfo = document.getElementById('chatBedInfo');
    const micButton = document.getElementById('micButton');
    const voiceWaveform = document.getElementById('voiceWaveform');
    const transcriptBox = document.getElementById('transcriptBox');
    const callStatus = document.getElementById('callStatus');
    const callTimer = document.getElementById('callTimer');

    document.getElementById('chatBtn').onclick = ()=>{
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      chatModal.classList.remove('hidden');
      chatModal.classList.add('flex');
      chatBedInfo.textContent = `‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${currentBed.id} - ${currentBed.patientName} (${currentBed.status === STATUS.CRITICAL ? '‡∏ß‡∏¥‡∏Å‡∏§‡∏ï' : '‡∏õ‡∏Å‡∏ï‡∏¥'})`;
      
      callStatus.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      callStartTime = Date.now();
      timerInterval = setInterval(updateTimer, 1000);
      transcriptBox.innerHTML = '<div class="text-gray-400 text-center">‡∏Å‡∏î‡πÑ‡∏°‡∏Ñ‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢...</div>';
    };

    document.getElementById('closeChatModal').onclick = ()=>{
      chatModal.classList.add('hidden');
      chatModal.classList.remove('flex');
      if(timerInterval) clearInterval(timerInterval);
      isListening = false;
      voiceWaveform.classList.add('hidden');
    };
    
    chatModal.addEventListener('click', (e)=>{
      if(e.target===chatModal){
        chatModal.classList.add('hidden');
        chatModal.classList.remove('flex');
        if(timerInterval) clearInterval(timerInterval);
        isListening = false;
        voiceWaveform.classList.add('hidden');
      }
    });

    function updateTimer(){
      if(!callStartTime) return;
      const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
      const seconds = (elapsed % 60).toString().padStart(2, '0');
      callTimer.textContent = `${minutes}:${seconds}`;
    }

    micButton.onclick = async ()=>{
      if(!isListening){
        isListening = true;
        micButton.classList.add('bg-gradient-to-br', 'from-green-500', 'to-emerald-600');
        micButton.classList.remove('from-red-500', 'to-pink-600');
        voiceWaveform.classList.remove('hidden');
        callStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á...';
        
        setTimeout(()=>{
          transcriptBox.innerHTML = '<div class="text-blue-600 font-semibold mb-2">‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•:</div><div>"‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡∏ö?"</div>';
          
          setTimeout(()=>{
            micButton.classList.remove('from-green-500', 'to-emerald-600');
            micButton.classList.add('from-red-500', 'to-pink-600');
            voiceWaveform.classList.add('hidden');
            isListening = false;
            callStatus.textContent = '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏≠‡∏ö...';
            
            getPatientResponse("‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡∏ö?");
          }, 3000);
        }, 2000);
      }
    };

    async function getPatientResponse(nurseMessage){
      try {
        const response = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: "claude-sonnet-4-20250514",
            max_tokens: 500,
            messages: [
              { 
                role: "user", 
                content: `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${currentBed.id}
‡∏ä‡∏∑‡πà‡∏≠: ${currentBed.patientName}
‡πÇ‡∏£‡∏Ñ: ${currentBed.disease}
‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${currentBed.status === STATUS.CRITICAL ? '‡∏ß‡∏¥‡∏Å‡∏§‡∏ï - ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏™‡∏ö‡∏≤‡∏¢ ‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢ ‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏•‡∏µ‡∏¢' : '‡∏õ‡∏Å‡∏ï‡∏¥ - ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏∑‡πâ‡∏ô‡∏ï‡∏±‡∏ß ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ'}
‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡πâ‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏à: ${currentBed.hr} bpm
‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥: ${currentBed.temp} ¬∞C

‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• ‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô‡πÜ 1-2 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á ‡∏û‡∏π‡∏î‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡∏π‡πà

‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ñ‡∏≤‡∏°: "${nurseMessage}"`
              }
            ],
          })
        });

        const data = await response.json();
        const patientReply = data.content.map(item => item.type === "text" ? item.text : "").join("");
        
        transcriptBox.innerHTML += '<div class="text-green-600 font-semibold mt-3 mb-2">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</div><div>"' + patientReply + '"</div>';
        callStatus.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      } catch (error) {
        transcriptBox.innerHTML += '<div class="text-red-600 mt-3">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ</div>';
        callStatus.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      }
    }

    // History modal
    const historyModal = document.getElementById('historyModal');
    document.getElementById('historyBtn').onclick = ()=>{
      historyModal.classList.remove('hidden');
      historyModal.classList.add('flex');
      renderHistory();
    };

    document.getElementById('closeHistoryModal').onclick = ()=>{
      historyModal.classList.add('hidden');
      historyModal.classList.remove('flex');
    };

    historyModal.addEventListener('click', (e)=>{
      if(e.target===historyModal){
        historyModal.classList.add('hidden');
        historyModal.classList.remove('flex');
      }
    });

    function renderHistory(){
      const historyList = document.getElementById('historyList');
      historyList.innerHTML = '';
      
      if(statusHistory.length === 0){
        historyList.innerHTML = '<div class="text-center text-gray-400 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</div>';
        return;
      }
      
      statusHistory.forEach(entry => {
        const oldColor = entry.oldStatus === STATUS.CRITICAL ? 'red' : entry.oldStatus === STATUS.OCCUPIED ? 'yellow' : 'green';
        const newColor = entry.newStatus === STATUS.CRITICAL ? 'red' : entry.newStatus === STATUS.OCCUPIED ? 'yellow' : 'green';
        const oldText = entry.oldStatus === STATUS.CRITICAL ? '‡∏ß‡∏¥‡∏Å‡∏§‡∏ï' : entry.oldStatus === STATUS.OCCUPIED ? '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏ß‡πà‡∏≤‡∏á';
        const newText = entry.newStatus === STATUS.CRITICAL ? '‡∏ß‡∏¥‡∏Å‡∏§‡∏ï' : entry.newStatus === STATUS.OCCUPIED ? '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏ß‡πà‡∏≤‡∏á';
        
        historyList.innerHTML += `
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="text-sm text-gray-500">${entry.time}</div>
              <div class="font-bold">${entry.bedId}</div>
              <div class="text-sm text-gray-600">${entry.patientName || '-'}</div>
            </div>
            <div class="flex items-center gap-2">
              <span class="px-2 py-1 rounded text-xs font-bold bg-${oldColor}-100 text-${oldColor}-700">${oldText}</span>
              <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
              <span class="px-2 py-1 rounded text-xs font-bold bg-${newColor}-100 text-${newColor}-700">${newText}</span>
            </div>
          </div>
        `;
      });
    }

    function renderBuildings(filterCode=null, searchTerm=''){
      const container = document.getElementById('buildingsContainer');
      container.innerHTML='';
      const toShow = hospital.filter(h=>filterCode? h.code===filterCode : true);
      
      toShow.forEach(building=>{
        const section = document.createElement('section');
        section.className = 'bg-white border-2 border-gray-200 rounded-xl shadow-md overflow-hidden';
        section.innerHTML = `<div class="bg-gradient-to-r from-blue-100 to-cyan-100 border-b-2 border-gray-200 px-5 py-4"><h3 class="font-bold text-gray-900 text-lg">${building.name} <span class="text-sm text-gray-600 font-normal">(${building.beds.length} ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á)</span></h3></div>`;
        const grid = document.createElement('div');
        grid.className='grid grid-cols-4 md:grid-cols-8 gap-3 p-5';
        
        building.beds.forEach(bed=>{
          if(searchTerm && !bed.id.toLowerCase().includes(searchTerm.toLowerCase()) && !(bed.patientName && bed.patientName.toLowerCase().includes(searchTerm.toLowerCase()))) return;
          
          const card = document.createElement('button');
          let borderColor = '#d1d5db';
          if(bed.status===STATUS.CRITICAL) borderColor='#dc2626';
          else if(bed.status===STATUS.OCCUPIED) borderColor='#eab308';
          else borderColor='#22c55e';
          card.className='bed-card text-left p-3 rounded-xl border-2' + (bed.isCalling ? ' calling' : '');
          card.style.borderColor = borderColor;
          
          let content = `<div class="text-center"><div class="text-sm font-bold text-gray-900 mb-1">${bed.id}</div>`;
          if(bed.hr) content += `<div class="text-xs text-gray-600 mb-1 font-medium">${bed.hr} bpm</div>`;
          if(bed.patientName) content += `<div class="text-xs text-gray-500 mb-1 truncate">${bed.patientName}</div>`;
          content += `${statusBadge(bed.status)}</div>`;
          
          card.innerHTML = content;
          card.setAttribute('data-id', bed.id);
          card.onclick = ()=>openModal(bed);
          grid.appendChild(card);
        });
        
        section.appendChild(grid);
        container.appendChild(section);
      });
      
      updateOverview();
      document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('th-TH');
    }

    buildingSelect.onchange = ()=>renderBuildings(buildingSelect.value==='all'?null:buildingSelect.value, document.getElementById('search').value);
    document.getElementById('search').addEventListener('input', (e)=>renderBuildings(buildingSelect.value==='all'?null:buildingSelect.value, e.target.value));
    
    document.getElementById('refreshBtn').onclick = ()=>{
      hospital.forEach(b=>b.beds.forEach(bd=>{
        const oldStatus = bd.status;
        const r=Math.random();
        bd.status = r>0.97 ? STATUS.CRITICAL : r>0.6 ? STATUS.OCCUPIED : STATUS.AVAILABLE;
        
        if(oldStatus !== bd.status){
          addToHistory(bd, oldStatus, bd.status);
        }
        
        bd.patientName = bd.status === STATUS.AVAILABLE ? null : THAI_NAMES[Math.floor(Math.random()*THAI_NAMES.length)];
        bd.age = bd.status === STATUS.AVAILABLE ? null : Math.floor(Math.random()*60)+20;
        bd.gender = bd.status === STATUS.AVAILABLE ? null : (Math.random()>0.5 ? '‡∏ä‡∏≤‡∏¢' : '‡∏´‡∏ç‡∏¥‡∏á');
        bd.disease = bd.status === STATUS.AVAILABLE ? null : DISEASES[Math.floor(Math.random()*DISEASES.length)];
        bd.daysAdmitted = bd.status === STATUS.AVAILABLE ? null : Math.floor(Math.random()*10)+1;
        bd.hr = bd.status===STATUS.AVAILABLE ? null : (bd.status===STATUS.CRITICAL ? Math.floor(40+Math.random()*40) : Math.floor(60+Math.random()*30));
        bd.temp = bd.status === STATUS.AVAILABLE ? null : (36.5 + Math.random()*2).toFixed(1);
        bd.bp = bd.status === STATUS.AVAILABLE ? null : `${Math.floor(100+Math.random()*40)}/${Math.floor(60+Math.random()*20)}`;
        bd.spo2 = bd.status === STATUS.AVAILABLE ? null : (bd.status === STATUS.CRITICAL ? Math.floor(85+Math.random()*10) : Math.floor(95+Math.random()*5));
        bd.medications = bd.status === STATUS.AVAILABLE ? [] : MEDICATIONS.slice(0, Math.floor(Math.random()*3)+1);
        bd.doctorNotes = bd.status === STATUS.AVAILABLE ? null : DOCTOR_NOTES_EXAMPLES[Math.floor(Math.random()*DOCTOR_NOTES_EXAMPLES.length)];
        bd.lastUpdate = new Date().toLocaleTimeString();
      }));
      renderBuildings(buildingSelect.value==='all'?null:buildingSelect.value, document.getElementById('search').value);
    };

    renderBuildings();

    // Update vital signs every 5 seconds
    setInterval(()=>{
      hospital.forEach(building=>{
        building.beds.forEach(bed=>{
          if(bed.status !== STATUS.AVAILABLE){
            bed.hr = bed.status===STATUS.CRITICAL ? Math.floor(40+Math.random()*40) : Math.floor(60+Math.random()*30);
            bed.temp = (36.5 + Math.random()*2).toFixed(1);
            bed.spo2 = bed.status === STATUS.CRITICAL ? Math.floor(85+Math.random()*10) : Math.floor(95+Math.random()*5);
            
            const card = document.querySelector(`.bed-card[data-id="${bed.id}"]`);
            if(card){
              let content = `<div class="text-center"><div class="text-sm font-bold text-gray-900 mb-1">${bed.id}</div>`;
              if(bed.hr) content += `<div class="text-xs text-gray-600 mb-1 font-medium">${bed.hr} bpm</div>`;
              if(bed.patientName) content += `<div class="text-xs text-gray-500 mb-1 truncate">${bed.patientName}</div>`;
              content += `${statusBadge(bed.status)}</div>`;
              card.innerHTML = content;
            }

            if(modal.classList.contains('flex') && modalTitle.textContent.includes(bed.id)){
              modalHR.textContent = bed.hr ? `${bed.hr} bpm` : '-';
              modalTemp.textContent = bed.temp ? `${bed.temp} ¬∞C` : '-';
              modalSpO2.textContent = bed.spo2 ? `${bed.spo2}%` : '-';
              
              if(bed.hr){
                const speed = Math.max(0.5, 2 - (bed.hr-60)/100);
                ecgPath.style.animation = `draw ${speed}s linear infinite`;
              }
            }
          }
        });
      });
    }, 5000);

    // Update bed status every 1 minute
    setInterval(()=>{
      hospital.forEach(building=>{
        building.beds.forEach(bed=>{
          if(Math.random() < 0.1){
            const oldStatus = bed.status;
            const r=Math.random();
            bed.status = r>0.97 ? STATUS.CRITICAL : r>0.6 ? STATUS.OCCUPIED : STATUS.AVAILABLE;
            
            if(oldStatus !== bed.status){
              addToHistory(bed, oldStatus, bed.status);
              
              if(bed.status === STATUS.CRITICAL){
                showAlert(bed, 'üö® ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏Å‡∏§‡∏ï!');
              }
            }
            
            bed.patientName = bed.status === STATUS.AVAILABLE ? null : (bed.patientName || THAI_NAMES[Math.floor(Math.random()*THAI_NAMES.length)]);
            bed.age = bed.status === STATUS.AVAILABLE ? null : (bed.age || Math.floor(Math.random()*60)+20);
            bed.gender = bed.status === STATUS.AVAILABLE ? null : (bed.gender || (Math.random()>0.5 ? '‡∏ä‡∏≤‡∏¢' : '‡∏´‡∏ç‡∏¥‡∏á'));
            bed.disease = bed.status === STATUS.AVAILABLE ? null : (bed.disease || DISEASES[Math.floor(Math.random()*DISEASES.length)]);
            bd.daysAdmitted = bed.status === STATUS.AVAILABLE ? null : (bed.daysAdmitted || Math.floor(Math.random()*10)+1);
            bed.hr = bed.status===STATUS.AVAILABLE ? null : (bed.status===STATUS.CRITICAL ? Math.floor(40+Math.random()*40) : Math.floor(60+Math.random()*30));
            bed.temp = bed.status === STATUS.AVAILABLE ? null : (36.5 + Math.random()*2).toFixed(1);
            bed.bp = bed.status === STATUS.AVAILABLE ? null : `${Math.floor(100+Math.random()*40)}/${Math.floor(60+Math.random()*20)}`;
            bed.spo2 = bed.status === STATUS.AVAILABLE ? null : (bed.status === STATUS.CRITICAL ? Math.floor(85+Math.random()*10) : Math.floor(95+Math.random()*5));
            bed.medications = bed.status === STATUS.AVAILABLE ? [] : (bed.medications.length > 0 ? bed.medications : MEDICATIONS.slice(0, Math.floor(Math.random()*3)+1));
            bed.doctorNotes = bed.status === STATUS.AVAILABLE ? null : (bed.doctorNotes || DOCTOR_NOTES_EXAMPLES[Math.floor(Math.random()*DOCTOR_NOTES_EXAMPLES.length)]);
            bed.lastUpdate = new Date().toLocaleTimeString();
          }

          const card = document.querySelector(`.bed-card[data-id="${bed.id}"]`);
          if(card){
            let content = `<div class="text-center"><div class="text-sm font-bold text-gray-900 mb-1">${bed.id}</div>`;
            if(bed.hr) content += `<div class="text-xs text-gray-600 mb-1 font-medium">${bed.hr} bpm</div>`;
            if(bed.patientName) content += `<div class="text-xs text-gray-500 mb-1 truncate">${bed.patientName}</div>`;
            content += `${statusBadge(bed.status)}</div>`;
            card.innerHTML = content;
            
            let borderColor = '#d1d5db';
            if(bed.status===STATUS.CRITICAL) borderColor='#dc2626';
            else if(bed.status===STATUS.OCCUPIED) borderColor='#eab308';
            else borderColor='#22c55e';
            card.style.borderColor = borderColor;
          }

          if(modal.classList.contains('flex') && modalTitle.textContent.includes(bed.id)){
            modalStatus.textContent = bed.status === STATUS.AVAILABLE ? '‡∏ß‡πà‡∏≤‡∏á' : bed.status === STATUS.OCCUPIED ? '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏ß‡∏¥‡∏Å‡∏§‡∏ï';
            modalPatientName.textContent = bed.patientName || '-';
            modalPatientAge.textContent = bed.age && bed.gender ? `${bed.age} ‡∏õ‡∏µ / ${bed.gender}` : '-';
            modalDisease.textContent = bed.disease || '-';
            modalAdmitDate.textContent = bed.daysAdmitted ? `${bed.daysAdmitted} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß` : '-';
            modalHR.textContent = bed.hr ? `${bed.hr} bpm` : '-';
            modalTemp.textContent = bed.temp ? `${bed.temp} ¬∞C` : '-';
            modalBP.textContent = bed.bp || '-';
            modalSpO2.textContent = bed.spo2 ? `${bed.spo2}%` : '-';
            
            if(bed.hr){
              const speed = Math.max(0.5, 2 - (bed.hr-60)/100);
              ecgPath.style.animation = `draw ${speed}s linear infinite`;
            }
          }
        });
      });
      updateOverview();
    }, 60000);

    // ECG keyframes
    const style = document.createElement('style');
    style.textContent = `@keyframes draw{0%{stroke-dashoffset:1000}20%{stroke-dashoffset:600}40%{stroke-dashoffset:1000}100%{stroke-dashoffset:1000}}`;
    document.head.appendChild(style);
  </script>
</body>
</html>